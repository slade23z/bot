var responses = {
	"NOTFOUND" : {
				 "weight" : 0,
				 "responses" : [
						"Infelizmente eu não sei fazer isso.",
						"Eu não sei o que é?",
					]
				},
	"desculpa" : {
				 "weight" : 1,
				 "responses" : ["Não precisa se desculpar.", "Desculpas não são necessárias.", "Nem precisa pedir desculpas"]},
	//Cumprimentos
	"olá" : {
				 "weight" : 1,
				 "responses" : ["Olá! Qual receita você gostaria hoje?", "Opa, qual receita você manda?"]},
	"ola" : {
				 "weight" : 1,
				 "responses" : ["Olá! Qual receita você gostaria hoje?", "Opa, qual receita você manda?"]},
	"oi" : {
				 "weight" : 1,
				 "responses" : ["Olá! Qual receita você gostaria hoje?", "Opa, qual receita você manda?"]},
	"opa" : {
				 "weight" : 1,
				 "responses" : ["Olá! Qual receita você gostaria hoje?", "Opa, qual receita você manda?"]},
	//====
	"como voce esta" : {
				 "weight" : 2,
				 "responses" : ["Estou ótima e vocês?"]},
	"como você está" : {
				 "weight" : 2,
				 "responses" : ["Estou ótima e vocês?"]},
	"como vc está" : {
				 "weight" : 2,
				 "responses" : ["Estou ótima e vocês?"]},
	"vc ta bem" : {
				 "weight" : 2,
				 "responses" : ["Estou ótima e vocês?"]},
	"como ce ta" : {
				 "weight" : 2,
				 "responses" : ["Estou ótima e vocês?"]},
	"estou bem" : {
				 "weight" : 1,
				 "responses" : ["Que bom! Qual receita você gostaria de experimentar?"]},
	"estou otimo" : {
				 "weight" : 1,
				 "responses" : ["Que bom! Qual receita você gostaria de experimentar?"]},
	"estou otima" : {
				 "weight" : 1,
				 "responses" : ["Que bom! Qual receita você gostaria de experimentar?"]},
	"to bem" : {
				 "weight" : 1,
				 "responses" : ["Que bom! Qual receita você gostaria de experimentar?"]},
	"to otimo" : {
				 "weight" : 1,
				 "responses" : ["Que bom! Qual receita você gostaria de experimentar?"]},
	"to otima" : {
				 "weight" : 1,
				 "responses" : ["Que bom! Qual receita você gostaria de experimentar?"]},
	"sim" : {
				 "weight" : 1,
				 "responses" : ["Por que você disse isso?","Você me parece ser bem positivo."]
				},
	"nao" : {
				 "weight" : 1,
				 "responses" : ["Por que não?","Você tem certeza?"]},
	"tchau" : {
				 "weight" : 1,
				 "responses" : ["Tchau! Até mais!"]},
	"sair" : {
				 "weight" : 1,
				 "responses" : ["Tchau! Até mais!"]},
	"receitas conhecidas" : {
				 "weight" : 1,
				 "responses" : ["Conheço várias receitas. Pergunte alguma e te falarei, caso eu conheça ela."]},
	"receita conhecidas" : {
				 "weight" : 1,
				 "responses" : ["Conheço várias receitas. Pergunte alguma e te falarei, caso eu conheça ela."]},
	"receitas conhecida" : {
				 "weight" : 1,
				 "responses" : ["Conheço várias receitas. Pergunte alguma e te falarei, caso eu conheça ela."]},
	"bom dia" : {
				 "weight" : 1,
				 "responses" : ["Bom dia! Olá novamente, qual receita gostaria hoje?", "Bom dia. Qual a receita de hoje?", "Dia! Qual é a receita do dia?"]},
	"boa tarde" : {
				 "weight" : 1,
				 "responses" : ["Boa tarde! Como vão as coisas?", "Boa tarde! Qual seria a receita de hoje?"]},
	"boa noite" : {
				 "weight" : 1,
				 "responses" : ["Boa noite! Qual seria a receita desta noite?", "Que ótima noite, não? Qual seria a receita noturna desta vez?"]},
	"chocolate" : {
				 "weight" : 2,
				 "responses" : ["Ingredientes - Massa<br>1 xícara de chá de leite<br>1 xícara de chá de óleo de soja<br>2 unidades de ovo<br>2 xícaras de chá de farinha de trigo<br>1 xícara de chá de achocolatado em pó<br>1 xícara de chá de açúcar<br>1 colheres de sopa de fermento químico em pó<br>Ingredientes - Cobertura<br>2 colheres de sopa de manteiga<br>3 colheres de sopa de achocolatado em pó<br>3 colheres de sopa de açúcar<br>5 colheres de sopa de leite<br>Massa: Em um liquidificador adicione os ovos, o chocolate em pó, a manteiga, a farinha de trigo, o açúcar e o leite, depois bata por 5 minutos. Adicione o fermento e misture com uma espátula delicadamente. Em uma forma untada, despeje a massa e asse em forno médio (180 ºC) preaquecido por cerca de 40 minutos. Não se esqueça de usar uma forma alta para essa receita: como l leva duas colheres de fermento, ela cresce bastante! Outra solução pode ser colocar apenas uma colher de fermento e manter a sua receita em uma forma pequena.<br>Calda: Em uma panela, aqueça a manteiga e misture o chocolate em pó até que esteja homogêneo. Acrescente o creme de leite e misture bem até obter uma consistência cremosa. Desligue o fogo e acrescente o açúcar."]}, 
	"cenoura" : {
				 "weight" : 2,
				 "responses" : ["Em um liquidificador, adicione a cenoura, os ovos e o óleo, depois misture. Acrescente o açúcar e bata novamente por 5 minutos. Em uma tigela ou na batedeira, adicione a farinha de trigo e depois misture novamente.\nAcrescente o fermento e misture lentamente com uma colher.\nAsse em um forno preaquecido a 180° C por aproximadamente 40 minutos.\n"]},
	"maracuja" : {
				 "weight" : 2,
				 "responses" : ["Modo de preparo: No liquidificador, bata os ovos, o açúcar, o suco, o óleo e a farinha até obter um creme homogêneo. Adicione o fermento e misture com uma colher.Despeje em uma fôrma de 25cm x 35cm untada e polvilhada, e leve ao forno médio, preaquecido, por 30 minutos ou até assar e dourar.Bata a polpa no liquidificador com o suco concentrado usando a tecla pulsar 2 vezes somente para soltar.Leve ao fogo médio com o leite condensado mexendo sempre por 5 minutos. Fure o bolo com um palito e regue com a calda.Deixe esfriar, corte em quadrados e embrulhe um a um em papel alumínio. Leve à geladeira por 4 horas antes de servir."]},	
	"banana" : {
				 "weight" : 2,
				 "responses" : ["Modo de preparo: Bata no liquidificador as bananas, os ovos, o óleo e o açúcar. Transfira para uma tigela e acrescente os demais ingredientes, misturando com uma colher.\nUnte e enfarinhe uma fôrma de buraco no meio de 22 cm de diâmetro, coloque a massa e leve ao forno médio, preaquecido, por 30 minutos.\nRetire do forno, deixe esfriar e desenforme. Polvilhe com açúcar de confeiteiro e sirva. Se desejar, decore com rodelas de banana passadas por suco de limão.\n"]},
	"iogurte" : {
				 "weight" : 2,
				 "responses" : ["Na batedeira, bata as claras com o sal até obter ponto de neve e reserve. Na batedeira, em outra tigela, bata as gemas com metade do açúcar e a manteiga até ficar fofo. Adicione o iogurte, o mel e o açúcar restante e bata até misturar tudo. Aos poucos, acrescente a farinha e por último o fermento. Despeje em uma fôrma de 22cm de diâmetro untada e enfarinhada e leve ao forno médio, preaquecido, por 40 minutos ou até que ao enfiar um palito, ele saia limpo. Espere esfriar e desenforme. Misture o açúcar de confeiteiro com o suco de limão e espalhe sobre o bolo. Se desejar, decore com raspas de limão"]},
	"leite condensado" : {
				 "weight" : 2,
				 "responses" : ["Na batedeira, bata as claras em neve e reserve. Ainda na batedeira, em outra tigela, bata a manteiga e adicione o leite condensado aos poucos, sem parar de bater, até obter uma mistura cremosa. Coloque as gemas, uma de cada vez, sem parar de bater. Desligue a batedeira e acrescente a farinha e o fermento. Delicadamente incorpore as claras em neve. Despeje em uma fôrma de buraco no meio de 22cm diâmetro decorada, untada e enfarinhada. Leve ao forno médio, preaquecido, por 40 minutos. Regue com os ingredientes da calda misturados. Desenforme e sirva."]},
	"doce de leite" : {
				 "weight" : 2,
				 "responses" : ["No liquidificador, bata os ovos, o açúcar, o óleo, o leite e o amendoim por 1 minuto. Despeje em uma tigela e misture a farinha, a maisena e o fermento com uma colher. Transfira para uma fôrma de 24cm de diâmetro de buraco no meio untada e enfarinhada, e leve ao forno médio, preaquecido, por 35 minutos ou até assar e dourar. Desenforme morno e cubra com o doce de leite misturado com o creme de leite. Polvilhe com a paçoca e sirva."]},
	"coco" : {
				 "weight" : 2,
				 "responses" : ["Bata todos os ingredientes no liquidificador até ficar homogêneo. Despeje em uma fôrma de buraco no meio de 20cm de diâmetro untada e enfarinhada e leve ao forno médio, preaquecido, por 35 minutos ou até dourar. Deixe esfriar, desenforme e sirva."]},
	"fuba" : {
				 "weight" : 2,
				 "responses" : ["Bata no liquidificador, os ovos, o leite, o fubá, o açúcar, o parmesão e o óleo até ficar homogêneo. Adicione o fermento em pó e bata por mais minuto. Despeje em uma fôrma de buraco no meio de 24cm de diâmetro untada e enfarinhada e leve ao forno médio, preaquecido, por 25 minutos ou até dourar. Desenforme ainda morno, polvilhe com o açúcar e sirva."]},
	"abacaxi com hortelã" : {
				 "weight" : 2,
				 "responses" : ["Em uma tigela, coloque a farinha, o fermento e a hortelã. Bata os demais ingredientes no liquidificador e misture com os da tigela. Coloque em uma fôrma de buraco no meio de 22cm de diâmetro untada e enfarinhada e leve ao forno médio, preaquecido, por 30 minutos ou até que, ao enfiar um palito, ele saia limpo. Retire do forno, espere esfriar e desenforme."]},


};

var synonyms = {
	"desculpa" : [
		"peça desculpas"
	],
	"voce" : [
		"você",
		"vc"
	]
};

var responsesWithWildcard = {
	"eu estou *1-3* feliz" : {	
							weight : 20,
							replacementWord : "estou feliz"
						},
	"eu estou *1-3* triste" : {	
							weight : 20,
							replacementWord : "estou triste"
						},
	"eu estou *1-3* entediado" : {	
							weight : 20,
							replacementWord : "estou triste"
						},
	"quais receitas *1-3*" : {	
							weight : 20,
							replacementWord : "receitas conhecidas"
						}

	
};


var initialMessages = ["Olá, eu me chamo Ana Maria Bot! Qual receita de bolo você gostaria hoje?"];
var endChatTerms = ["tchau","sair"];
var chatHistory = [];
var keywords = [];
var conversationOver = false;
var usedResponses = [];

function startElizaChat(){
	
	getKeywordsByWeight();


	var initialMessage = initialMessages[Math.floor(Math.random()*initialMessages.length)];
	chatHistory.push({ isEliza : true, content : initialMessage });
	displayChat();

}

function getKeywordsByWeight(){
	var weights = [];
	var tempKeywords = [];
	
	for(var responseKeyword in responses){
		var weight = responses[responseKeyword].weight;
		tempKeywords[responseKeyword] = weight;

		if(!weights.includes(weight)){
			weights.push(weight);
		}
	}

	for(var wordWithResponse in synonyms){
		if(wordWithResponse in tempKeywords){
			var weight = tempKeywords[wordWithResponse];

			for(var i = 0;i < synonyms[wordWithResponse].length;i++){
				var similarWord = synonyms[wordWithResponse][i];
				tempKeywords[similarWord] = weight;
			}
		}
	}

	for(var word in responsesWithWildcard){
		var weight = responsesWithWildcard[word].weight;

		if(!weights.includes(weight)){
			weights.push(weight);
		}
		
		tempKeywords[word] = weight;
	}

	weights = weights.sort(sortNumber);
	
	for(var i = 0;i < weights.length;i++){
		var weight = weights[i];
		for(var word in tempKeywords){
			if(tempKeywords[word] === weight && word != "NOTFOUND"){
				var obj = {};
				obj.word = word;
				obj.weight = weight;

				keywords.push(obj);
			}
		}
	}
}

function sendElizaNewMessage(newMessage){
	
	//Add to UI
	chatHistory.push({ isEliza : false, content : newMessage });
	displayChat();
	clearSendTextbox();

	if(!conversationOver){
		newMessage = processInput(newMessage);
		var response = analyze(newMessage);
	}else{
		var response = "Nossa conversa terminou. Caso queira recomeçar, atualize a página.";
	}

	setTimeout(function(){
		usedResponses.push(response);
		chatHistory.push({ isEliza : true, content : response });
		displayChat();
	}, determineResponseTime());

}

function analyze(newMessage){
	var found = false;
	var response = '';

	for (var i = 0;i < keywords.length;i++) {
		var word = keywords[i].word;
		
		if(endChatTerms.contains(newMessage)){
			conversationOver = true;
			newMessage = "goodbye";
		}

		if(word.indexOf("*") != -1 && containsKeywordWithWildcard(newMessage, word) && !found){
			
			response = selectResponse(findBasicKeywordFromKeywordWithWildcard(word));
			found = true;

		}else if((newMessage.indexOf(word) != -1 && newMessage.length == word.length || newMessage.indexOf(word + " ") != -1 || newMessage.indexOf(" " + word) != -1) && !found){

			response = selectResponse(word);
			
			found = true;

		}
		

		if(found && response.indexOf("*") !== -1){

				var remainingInput = newMessage.substring(newMessage.indexOf(word) + word.length+1, newMessage.length);

				var rightOfWildcardInResponse = response.substring(response.indexOf("*")+1);

				var startOfResponseToWildcard = response.substring(0, response.indexOf("*"));

				var startOfInputMinusOneCharacter = remainingInput.substring(0, remainingInput.length-1);

				var remainingOfInputOnRight = remainingInput.substring(remainingInput.length-1, remainingInput.length).replace("[^A-Za-z]","");

				response =  startOfResponseToWildcard + replaceWords(startOfInputMinusOneCharacter + remainingOfInputOnRight) + rightOfWildcardInResponse;

		}
		if(found){
			break;
		}
		

	}

	if(!found){
		response = responses["NOTFOUND"].responses[Math.floor(Math.random()*responses["NOTFOUND"].responses.length)];
	}

	return response;
}

function selectResponse(word){
	var potentialResponses = [];
	if(word in responses){

		potentialResponses = responses[word];
	}else{

		potentialResponses = findResponsesForSimilarWord(word);
	}

	
	var newResponses = [];
	var originalResponsesSize = potentialResponses.responses.length;


	for(var i = 0;i < originalResponsesSize;i++){
		newResponses.push(potentialResponses.responses[i]);

		if(potentialResponses.responses[i].indexOf("*") !== -1){
			newResponses.push(potentialResponses.responses[i]);
		}

		if(!usedResponses.contains(potentialResponses.responses[i])){
			newResponses.push(potentialResponses.responses[i]);
		}
	}
	return newResponses[Math.floor(Math.random()*newResponses.length)];
}

function processInput(message){
	message = message.toLowerCase();
	message = removePunctuation(message);
	return message;
}

function replaceWords(input){
	
	var wordsForReplacement = [];
	wordsForReplacement["eu"] = "voce";
	wordsForReplacement["voce"] = "eu";
	wordsForReplacement["eu"] = "voce";
	wordsForReplacement["meu"] = "seu";
	wordsForReplacement["sou"] = "estao";
	wordsForReplacement["estao"] = "sou";
	wordsForReplacement["foi"] = "estavam";
	wordsForReplacement["eu iria"] = "voce poderia";
	wordsForReplacement["eu tenho"] = "voce tem";
	wordsForReplacement["eu vou"] = "voce ira";
	wordsForReplacement["voce tem"] = "eu tenho";
	wordsForReplacement["você vai"] = "eu vou";
	wordsForReplacement["seu"] = "meu";
	wordsForReplacement["seu"] = "meu";
	wordsForReplacement["eu"] = "voce";
	
	var inputSplit = input.split(" ");

	var newSplit = [];
	for(var i = 0;i < inputSplit.length;i++){
		var currentInputWord = inputSplit[i];
		if(currentInputWord in wordsForReplacement){
			var replacementWord = wordsForReplacement[currentInputWord];
			newSplit[i] = replacementWord;

		}else{
			newSplit[i] = currentInputWord;
		}
	}

	var updatedMessage = "";
	for(var i = 0;i < newSplit.length;i++){
		var word = newSplit[i];
		if(updatedMessage != ""){
			updatedMessage += " ";
		}
		updatedMessage += word;
	}

	return updatedMessage;
}

function removePunctuation(message){
	//',;.?!:'
	message = message.replace(",","");
	message = message.replace(";","");
	message = message.replace(".","");
	message = message.replace("?","");
	message = message.replace("!","");
	message = message.replace(":","");
	
	
	return message;
}

function determineResponseTime(){
	var m = Math.floor(Math.random() * 2000) + 500;
	return m;
}
/*
 * Pego do: http://stackoverflow.com/questions/1063007/how-to-sort-an-array-of-integers-correctly
 */
function sortNumber(a,b) {
    return b - a;
}

function findResponsesForSimilarWord(word){
	var foundKey = "";
	for(var key in synonyms){
		var similarWords = synonyms[key];
		for(var i = 0;i < similarWords.length;i++){
			if(similarWords[i] == word){
				foundKey = key;
				break;
			}
		}
		if(foundKey != ""){
			break;
		}
	}

	
	return responses[foundKey];
}

function containsKeywordWithWildcard(input, keywordsWithWildcardStr){
	
	var responseWildcardObj = getResponseWildcardInfo(keywordsWithWildcardStr);

	var numberOfWordsInWildcard = 0;
	var foundKeywords = 0;
	var inputArray = input.split(" ");
	for(var i = 0;i < inputArray.length;i++){
		var currentWord = inputArray[i];
		
		if((foundKeywords >= responseWildcardObj.minNumWords && foundKeywords <= responseWildcardObj.maxNumWords) && !responseWildcardObj.keywords.contains(currentWord)){
			numberOfWordsInWildcard++;
		}

		if(responseWildcardObj.keywords.length > 0 && currentWord == responseWildcardObj.keywords[0]){

			responseWildcardObj.keywords.remove(currentWord);
			foundKeywords++;
		}
	}

	if(responseWildcardObj.keywords.length > 0){
		
		return false;
	}
	if(!(numberOfWordsInWildcard >= responseWildcardObj.minNumWords && numberOfWordsInWildcard <= responseWildcardObj.maxNumWords)){

		return false;
	}
	
	return true;
}

function findBasicKeywordFromKeywordWithWildcard(keywordsWithWildcardStr){
	var t =  responsesWithWildcard[keywordsWithWildcardStr].replacementWord;
	console.log("Replacement:" + t);
	return t;
}

function getResponseWildcardInfo(keywordsWithWildcardStr){
	var keywordsWithWildcard = keywordsWithWildcardStr.split(" ");
	
	var rulesInSingleStr = "";
	var positionOfWordBeforeOfWildcard = 0;
	var positionOfWordAfterOfWildcard = 0;
	for(var i = 0;i < keywordsWithWildcard.length;i++){
		var str = keywordsWithWildcard[i];
		
		positionOfWordAfterOfWildcard = i;

		if(str.indexOf("*") != -1){
			rulesInSingleStr = str;
			break;
		}
	}
	positionOfWordBeforeOfWildcard = positionOfWordAfterOfWildcard-1;


	keywordsWithWildcard = keywordsWithWildcard.remove(rulesInSingleStr);

	rulesInSingleStr = rulesInSingleStr.replace("*","").replace("*","");
	if(rulesInSingleStr.length < 3){
		return false;
	}

	var minNumWords = rulesInSingleStr.substring(0,1);
	var maxNumWords = rulesInSingleStr.substring(2);
	

	var obj = {
		minNumWords : minNumWords,
		maxNumWords : maxNumWords,
		wordBeforeWildcard : positionOfWordBeforeOfWildcard,
		wordAfterWildcard : positionOfWordAfterOfWildcard,
		keywords : keywordsWithWildcard
	};


	return obj;
}
/*
 * Pego de: http://stackoverflow.com/questions/5767325/how-to-remove-a-particular-element-from-an-array-in-javascript
 * Modificado
 */
Array.prototype.remove = function ( needle ) {
	var index = this.indexOf(needle);
	
	if(index > -1){
		this.splice(index, 1);
		return this;
	}
	return this;
}
/*
 * Pego de: http://stackoverflow.com/questions/12623272/how-to-check-if-a-string-array-contains-one-string-in-javascript
 */
Array.prototype.contains = function ( needle ) {
   for (i in this) {
      if (this[i] == needle) return true;
   }
   return false;
}
